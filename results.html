<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      text-align: center;
      margin: 0;
    }

    .result-card {
      display: inline-block;
      border: 1px solid #ccc;
      border-radius: 10px;
      margin: 10px;
      padding: 20px;
      width: 250px;
      background: #f5f5f5;
    }

    .result-card img {
      width: 100%;
      height: auto;
      border-radius: 8px;
    }

    #logoutBtn, #backToVoteBtn {
      position: fixed;
      padding: 10px 15px;
      font-size: 14px;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      z-index: 1000;
    }

    #logoutBtn {
      top: 20px;
      right: 20px;
      background-color: #dc3545;
    }

    #logoutBtn:hover {
      background-color: #c82333;
    }

    #backToVoteBtn {
      top: 20px;
      left: 20px;
      background-color: #28a745;
    }

    #backToVoteBtn:hover {
      background-color: #218838;
    }

    .delete-btn {
      margin-top: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }

    .delete-btn:hover {
      background-color: #0056b3;
    }

    #searchInput, #toggleChartBtn {
      padding: 10px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin: 10px;
    }

    #toggleChartBtn {
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }

    #toggleChartBtn:hover {
      background-color: #0056b3;
    }

    canvas {
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <button onclick="goBackToVote()" id="backToVoteBtn">üîô ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏ß‡∏ï</button>
  <button onclick="logout()" id="logoutBtn">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>

  <h1>üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï</h1>

  <input
    type="text"
    id="searchInput"
    placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£..."
    oninput="filterResults()"
  />

  <button onclick="toggleChart()" id="toggleChartBtn">üìä ‡∏î‡∏π‡∏Å‡∏£‡∏≤‡∏ü</button>

  <div id="results"></div>
  <canvas id="voteChart" width="800" height="400" style="display:none;"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const voterName = localStorage.getItem("voterName");
    const isAdmin = localStorage.getItem("isAdmin") === "true";
    if (!voterName) window.location.href = "login.html";

    const hiddenCandidates = JSON.parse(localStorage.getItem("hiddenCandidates") || "[]");

    const candidates = [];

    // ‚û§ ‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ã‡∏≤‡∏£‡πà‡∏≤
    candidates.push({
      id: 1,
      name: "‡∏ã‡∏≤‡∏£‡πà‡∏≤",
      image: "Mohamed_Salah_2018.jpg"
    });

    // ‚û§ ‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏µ‡πà 2‚Äì150
    for (let i = 2; i <= 150; i++) {
      candidates.push({
        id: i,
        name: `‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ ${i}`,
        image: "../assets/eth5.jpg"
      });
    }

    const votes = JSON.parse(localStorage.getItem("votes") || "{}");

    let totalVotes = 0;
    candidates.forEach(c => {
      c.voteCount = votes[c.id] || 0;
      totalVotes += c.voteCount;
    });

    candidates.forEach(c => {
      c.percent = totalVotes > 0 ? ((c.voteCount / totalVotes) * 100).toFixed(2) : "0.00";
    });

    candidates.sort((a, b) => b.voteCount - a.voteCount);

    const container = document.getElementById("results");

    const visibleCandidates = candidates.filter(c => !hiddenCandidates.includes(c.id));
    const hiddenOnly = isAdmin ? candidates.filter(c => hiddenCandidates.includes(c.id)) : [];

    visibleCandidates.forEach(c => {
      const div = document.createElement("div");
      div.className = "result-card";
      div.innerHTML = `
        <img src="${c.image}" alt="${c.name}" />
        <h3>${c.name}</h3>
        <p>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${c.voteCount} (${c.percent}%)</p>
        ${isAdmin ? `<button class="delete-btn" onclick="deleteVote(${c.id})">üóëÔ∏è ‡∏ã‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</button>` : ""}
      `;
      container.appendChild(div);
    });

    if (isAdmin && hiddenOnly.length > 0) {
      const separator = document.createElement("h2");
      separator.innerText = "üõë ‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô";
      container.appendChild(separator);

      hiddenOnly.forEach(c => {
        const div = document.createElement("div");
        div.className = "result-card";
        div.innerHTML = `
          <img src="${c.image}" alt="${c.name}" />
          <h3>${c.name}</h3>
          <p>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${c.voteCount} (${c.percent}%)</p>
          <p style="color: red;">üîí ‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</p>
          <button class="delete-btn" onclick="unhideCandidate(${c.id})">‚ôªÔ∏è ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏∑‡∏ô</button>
        `;
        container.appendChild(div);
      });

      // ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      const resetBtn = document.createElement("button");
      resetBtn.id = "resetHiddenBtn";
      resetBtn.innerText = "‚ôªÔ∏è ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
      resetBtn.onclick = resetHiddenCandidates;
      resetBtn.style = `
        padding: 10px 20px;
        font-size: 14px;
        background-color: #17a2b8;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        margin: 20px auto;
      `;
      container.appendChild(resetBtn);
    }

    function deleteVote(candidateId) {
      if (!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

      const hiddenList = JSON.parse(localStorage.getItem("hiddenCandidates") || "[]");
      if (!hiddenList.includes(candidateId)) {
        hiddenList.push(candidateId);
        localStorage.setItem("hiddenCandidates", JSON.stringify(hiddenList));
      }

      alert("‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
      location.reload();
    }

    function unhideCandidate(candidateId) {
      const hiddenList = JSON.parse(localStorage.getItem("hiddenCandidates") || "[]");
      const updated = hiddenList.filter(id => id !== candidateId);
      localStorage.setItem("hiddenCandidates", JSON.stringify(updated));
      alert("‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      location.reload();
    }

    function resetHiddenCandidates() {
      if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
      localStorage.removeItem("hiddenCandidates");
      alert("‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß");
      location.reload();
    }

    function logout() {
      localStorage.removeItem("voterName");
      localStorage.removeItem("voted");
      localStorage.removeItem("isAdmin");
      window.location.href = "login.html";
    }

    function goBackToVote() {
      window.location.href = "index.html";
    }

    function filterResults() {
      const query = document.getElementById("searchInput").value.toLowerCase();
      const cards = document.querySelectorAll(".result-card");
      cards.forEach(card => {
        const name = card.querySelector("h3").textContent.toLowerCase();
        card.style.display = name.includes(query) ? "inline-block" : "none";
      });
    }

    let chartVisible = false;
    let voteChart;

    function toggleChart() {
      const canvas = document.getElementById("voteChart");
      const cards = document.querySelectorAll(".result-card");
      chartVisible = !chartVisible;

      if (chartVisible) {
        canvas.style.display = "block";
        cards.forEach(card => card.style.display = "none");
        renderChart();
        document.getElementById("toggleChartBtn").innerText = "üìã ‡∏î‡∏π‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î";
      } else {
        canvas.style.display = "none";
        cards.forEach(card => card.style.display = "inline-block");
        document.getElementById("toggleChartBtn").innerText = "üìä ‡∏î‡∏π‡∏Å‡∏£‡∏≤‡∏ü";
      }
    }

    function renderChart() {
      const canvas = document.getElementById("voteChart");
      const top10 = candidates
        .filter(c => !hiddenCandidates.includes(c.id))
        .slice(0, 10);

      const labels = top10.map(c => c.name);
      const data = top10.map(c => c.voteCount);

      if (voteChart) voteChart.destroy();

      voteChart = new Chart(canvas, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô',
            data: data,
            backgroundColor: 'rgba(54, 162, 235, 0.8)'
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }
  </script>
</body>
</html>
